---
import { supabase } from "../../lib/supabase";
import Header from "../../components/ui/Header.astro";
import Schema from "../../components/seo/Schema.astro";
import { ClientRouter } from 'astro:transitions';

// 1. Pegar o "slug" da URL (ex: casa-horizonte-infinito)
const { slug } = Astro.params;

// 2. Buscar os dados no Supabase
const { data: project, error } = await supabase
  .from("projects")
  .select("*")
  .eq("slug", slug)
  .single();

// 3. Se não achar (erro 404), redireciona para home
if (error || !project) {
  return Astro.redirect("/404");
}

const pageTitle = `${project.title} | Ruth Medeiros Carvalho`;
---

<html lang="pt-br" class="scroll-smooth">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />
    <title>{pageTitle}</title>
    <meta name="description" content={project.seo_description} />
    <ClientRouter />
    
    <Schema siteTitle={pageTitle} description={project.seo_description} />
  </head>
  
  <body class="bg-stone-50 text-stone-900 antialiased font-sans selection:bg-stone-900 selection:text-white">
    <Header />

    <main>
      <section class="relative h-[80svh] w-full overflow-hidden">
        <div class="absolute inset-0 bg-black/20 z-10"></div>
        <img 
          src={project.cover_image} 
          alt={project.title}
          class="w-full h-full object-cover animate-fade-in"
          transition:name={`image-${project.slug}`} 
        />
        
        <div class="absolute bottom-0 left-0 w-full p-6 md:p-12 z-20 text-white bg-gradient-to-t from-black/80 to-transparent">
          <div class="max-w-screen-2xl mx-auto">
            <span class="block text-xs uppercase tracking-[0.2em] mb-2 text-stone-300">{project.category} · {project.completion_year}</span>
            <h1 class="font-serif text-5xl md:text-7xl lg:text-8xl leading-none">{project.title}</h1>
          </div>
        </div>
      </section>

      <section class="max-w-screen-2xl mx-auto px-6 md:px-12 py-24">
        <div class="flex flex-col lg:flex-row gap-16">
          
          <div class="lg:w-1/3 lg:h-screen lg:sticky lg:top-24 self-start">
            <h2 class="text-xs font-bold tracking-widest uppercase text-stone-500 mb-6">Sobre o Projeto</h2>
            
            <div class="prose prose-stone prose-lg font-light text-stone-800 mb-12 leading-relaxed">
              <p>{project.content}</p>
            </div>

            <div class="border-t border-stone-200 pt-8 grid grid-cols-2 gap-y-6 gap-x-4">
              <div>
                <span class="block text-[10px] uppercase tracking-widest text-stone-400">Localização</span>
                <span class="text-sm font-medium">{project.location}</span>
              </div>
              <div>
                <span class="block text-[10px] uppercase tracking-widest text-stone-400">Área</span>
                <span class="text-sm font-medium">{project.area_sqm}m²</span>
              </div>
              <div>
                <span class="block text-[10px] uppercase tracking-widest text-stone-400">Status</span>
                <span class="text-sm font-medium">{project.status}</span>
              </div>
              <div>
                <span class="block text-[10px] uppercase tracking-widest text-stone-400">Ano</span>
                <span class="text-sm font-medium">{project.completion_year}</span>
              </div>
            </div>

            <a href="/" class="inline-block mt-12 text-xs uppercase tracking-widest border-b border-stone-300 pb-1 hover:border-stone-900 transition-colors">
              ← Voltar ao Início
            </a>
          </div>

          <div class="lg:w-2/3 flex flex-col gap-8">
            {project.gallery_images && project.gallery_images.length > 0 ? (
              project.gallery_images.map((img: string, index: number) => (
                <div class="overflow-hidden bg-stone-200 aspect-video md:aspect-auto group">
                   <img 
                    src={img} 
                    alt={`Detalhe ${index + 1} de ${project.title}`}
                    class="w-full h-full object-cover transition-transform duration-[1.5s] ease-out group-hover:scale-105"
                    loading="lazy"
                  />
                </div>
              ))
            ) : (
              <p class="text-stone-400 italic">Mais imagens em breve...</p>
            )}
          </div>

        </div>
      </section>

      <section class="bg-stone-900 text-white py-24 text-center">
        <h3 class="font-serif text-3xl md:text-5xl mb-6">Gostou deste projeto?</h3>
        <p class="text-stone-400 mb-8 max-w-lg mx-auto font-light">Vamos discutir como transformar sua visão em realidade.</p>
        <a href="mailto:contato@ruthmedeiros.com" class="inline-block border border-white px-8 py-3 text-xs uppercase tracking-[0.2em] hover:bg-white hover:text-stone-900 transition-colors">
          Entrar em Contato
        </a>
      </section>

    </main>

    <footer class="bg-stone-950 text-stone-600 py-8 text-center text-xs border-t border-stone-900">
      <p>© 2026 Ruth Medeiros Carvalho</p>
    </footer>

  </body>
</html>